<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gravity Claw â€” Live Canvas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
    <style>
      :root {
        --bg: #0a0a0f;
        --surface: rgba(255, 255, 255, 0.04);
        --surface-hover: rgba(255, 255, 255, 0.08);
        --border: rgba(255, 255, 255, 0.08);
        --text: #e4e4e7;
        --text-muted: #71717a;
        --accent: #6366f1;
        --accent-glow: rgba(99, 102, 241, 0.3);
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
        --radius: 16px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .header {
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        background: rgba(10, 10, 15, 0.85);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--danger);
        transition: background 0.3s;
      }

      .status-dot.connected {
        background: var(--success);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
      }

      .status-label {
        font-size: 12px;
        color: var(--text-muted);
      }

      .btn {
        padding: 6px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--surface);
        color: var(--text);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn:hover {
        background: var(--surface-hover);
        border-color: var(--accent);
      }

      /* â”€â”€ Canvas Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .canvas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
        gap: 20px;
        padding: 24px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 80px 24px;
        color: var(--text-muted);
      }

      .empty-state .icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      .empty-state h2 {
        font-size: 20px;
        margin-bottom: 8px;
        color: var(--text);
      }
      .empty-state p {
        font-size: 14px;
        line-height: 1.6;
        max-width: 400px;
        margin: 0 auto;
      }

      /* â”€â”€ Widget Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .widget-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        animation: fadeIn 0.4s ease-out;
        transition: border-color 0.2s;
      }

      .widget-card:hover {
        border-color: rgba(99, 102, 241, 0.3);
      }

      .widget-card.full-width {
        grid-column: 1 / -1;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .widget-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
      }

      .widget-title {
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .widget-type-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 4px;
        background: var(--accent-glow);
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      .widget-body {
        padding: 18px;
      }

      .widget-time {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* â”€â”€ Chart Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .chart-container {
        position: relative;
        width: 100%;
        max-height: 320px;
      }

      /* â”€â”€ Table Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .data-table th {
        text-align: left;
        padding: 10px 14px;
        background: rgba(99, 102, 241, 0.08);
        color: var(--accent);
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
      }

      .data-table td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        color: var(--text);
      }

      .data-table tr:hover td {
        background: var(--surface-hover);
      }

      /* â”€â”€ Markdown Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .markdown-body {
        font-size: 14px;
        line-height: 1.7;
        color: var(--text);
      }

      .markdown-body h1,
      .markdown-body h2,
      .markdown-body h3 {
        color: var(--text);
        margin: 16px 0 8px;
      }

      .markdown-body h1 {
        font-size: 22px;
      }
      .markdown-body h2 {
        font-size: 18px;
      }
      .markdown-body h3 {
        font-size: 15px;
      }

      .markdown-body p {
        margin: 8px 0;
      }

      .markdown-body code {
        background: rgba(99, 102, 241, 0.12);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 13px;
        font-family: "JetBrains Mono", monospace;
      }

      .markdown-body pre {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 14px;
        overflow-x: auto;
        margin: 12px 0;
      }

      .markdown-body pre code {
        background: none;
        padding: 0;
      }

      .markdown-body ul,
      .markdown-body ol {
        padding-left: 20px;
        margin: 8px 0;
      }
      .markdown-body li {
        margin: 4px 0;
      }

      .markdown-body blockquote {
        border-left: 3px solid var(--accent);
        padding-left: 14px;
        color: var(--text-muted);
        margin: 12px 0;
      }

      /* â”€â”€ Form Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .canvas-form {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .form-group label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-glow);
      }

      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }

      .form-submit {
        padding: 10px 20px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        align-self: flex-start;
      }

      .form-submit:hover {
        filter: brightness(1.15);
        transform: translateY(-1px);
      }

      /* â”€â”€ HTML Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .html-body {
        font-size: 14px;
      }

      /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      @media (max-width: 500px) {
        .canvas-grid {
          grid-template-columns: 1fr;
          padding: 12px;
          gap: 12px;
        }
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <h1>ğŸ¦… Gravity Claw â€” Live Canvas</h1>
      <div class="header-actions">
        <div style="display: flex; align-items: center; gap: 6px">
          <div class="status-dot" id="statusDot"></div>
          <span class="status-label" id="statusLabel">Disconnected</span>
        </div>
        <button class="btn" onclick="clearCanvas()">ğŸ—‘ Clear</button>
        <span class="widget-time" id="clientCount">0 widgets</span>
      </div>
    </div>

    <!-- Canvas Grid -->
    <div class="canvas-grid" id="canvasGrid">
      <div class="empty-state" id="emptyState">
        <div class="icon">ğŸ–¼ï¸</div>
        <h2>Canvas is empty</h2>
        <p>
          Ask Gravity Claw to create charts, tables, forms, or other widgets.
          They'll appear here in real-time.
        </p>
      </div>
    </div>

    <script>
      // â”€â”€ WebSocket Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let ws = null;
      let reconnectTimeout = null;
      const widgets = [];

      function connect() {
        const protocol = location.protocol === "https:" ? "wss:" : "ws:";
        ws = new WebSocket(`${protocol}//${location.host}`);

        ws.onopen = () => {
          document.getElementById("statusDot").classList.add("connected");
          document.getElementById("statusLabel").textContent = "Connected";
          console.log("ğŸŸ¢ Canvas connected");
        };

        ws.onclose = () => {
          document.getElementById("statusDot").classList.remove("connected");
          document.getElementById("statusLabel").textContent =
            "Reconnecting...";
          console.log("ğŸ”´ Canvas disconnected â€” reconnecting in 3s");
          reconnectTimeout = setTimeout(connect, 3000);
        };

        ws.onerror = () => {
          ws.close();
        };

        ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);

            if (msg.type === "canvas") {
              addWidget(msg.item);
            } else if (msg.type === "history") {
              for (const item of msg.items) {
                addWidget(item);
              }
            } else if (msg.type === "clear") {
              widgets.length = 0;
              renderAll();
            }
          } catch (err) {
            console.error("Parse error:", err);
          }
        };
      }

      // â”€â”€ Widget Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function addWidget(item) {
        widgets.push(item);
        renderWidget(item);
        updateCount();
      }

      function renderAll() {
        const grid = document.getElementById("canvasGrid");
        grid.innerHTML = "";
        if (widgets.length === 0) {
          grid.innerHTML = `
          <div class="empty-state" id="emptyState">
            <div class="icon">ğŸ–¼ï¸</div>
            <h2>Canvas is empty</h2>
            <p>Ask Gravity Claw to create charts, tables, forms, or other widgets. They'll appear here in real-time.</p>
          </div>`;
          return;
        }
        for (const w of widgets) {
          renderWidget(w);
        }
        updateCount();
      }

      function renderWidget(item) {
        // Remove empty state if present
        const empty = document.getElementById("emptyState");
        if (empty) empty.remove();

        const card = document.createElement("div");
        card.className = "widget-card";
        card.id = `widget-${item.id}`;

        // Full-width for tables and large HTML
        if (item.type === "table" || item.type === "html") {
          card.classList.add("full-width");
        }

        const typeIcon =
          {
            chart: "ğŸ“Š",
            table: "ğŸ“‹",
            html: "ğŸ§©",
            form: "ğŸ“",
            markdown: "ğŸ“„",
          }[item.type] || "ğŸ“¦";

        const time = new Date(item.timestamp).toLocaleTimeString();

        card.innerHTML = `
        <div class="widget-header">
          <span class="widget-title">
            ${typeIcon} ${escapeHtml(item.title)}
          </span>
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="widget-type-badge">${item.type}</span>
            <span class="widget-time">${time}</span>
          </div>
        </div>
        <div class="widget-body" id="body-${item.id}"></div>
      `;

        document.getElementById("canvasGrid").appendChild(card);

        // Render body based on type
        const body = document.getElementById(`body-${item.id}`);

        switch (item.type) {
          case "chart":
            renderChart(body, item.content);
            break;
          case "table":
            renderTable(body, item.content);
            break;
          case "markdown":
            renderMarkdown(body, item.content);
            break;
          case "form":
            renderForm(body, item.content, item.id);
            break;
          case "html":
            renderHtml(body, item.content);
            break;
        }

        // Scroll into view
        card.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      // â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function renderChart(container, config) {
        const wrapper = document.createElement("div");
        wrapper.className = "chart-container";
        const canvas = document.createElement("canvas");
        wrapper.appendChild(canvas);
        container.appendChild(wrapper);

        // Apply dark theme defaults
        const chartConfig =
          typeof config === "string" ? JSON.parse(config) : config;

        // Enforce dark theme colors
        Chart.defaults.color = "#a1a1aa";
        Chart.defaults.borderColor = "rgba(255,255,255,0.06)";

        new Chart(canvas, chartConfig);
      }

      // â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function renderTable(container, data) {
        const tableData = typeof data === "string" ? JSON.parse(data) : data;
        const { headers = [], rows = [] } = tableData;

        let html = '<table class="data-table"><thead><tr>';
        for (const h of headers) {
          html += `<th>${escapeHtml(String(h))}</th>`;
        }
        html += "</tr></thead><tbody>";
        for (const row of rows) {
          html += "<tr>";
          for (const cell of row) {
            html += `<td>${escapeHtml(String(cell))}</td>`;
          }
          html += "</tr>";
        }
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // â”€â”€ Markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function renderMarkdown(container, content) {
        const text =
          typeof content === "string" ? content : JSON.stringify(content);
        container.innerHTML = `<div class="markdown-body">${marked.parse(text)}</div>`;
      }

      // â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function renderForm(container, config, widgetId) {
        const formData =
          typeof config === "string" ? JSON.parse(config) : config;
        const { fields = [], submitLabel = "Submit" } = formData;

        const form = document.createElement("form");
        form.className = "canvas-form";
        form.onsubmit = (e) => {
          e.preventDefault();
          const data = {};
          for (const field of fields) {
            data[field.name] = form.elements[field.name]?.value ?? "";
          }
          // Send back via WebSocket
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(
              JSON.stringify({
                type: "form_submit",
                widgetId,
                data,
              }),
            );
          }
          // Visual feedback
          const btn = form.querySelector(".form-submit");
          btn.textContent = "âœ… Submitted!";
          btn.disabled = true;
          setTimeout(() => {
            btn.textContent = submitLabel;
            btn.disabled = false;
          }, 2000);
        };

        for (const field of fields) {
          const group = document.createElement("div");
          group.className = "form-group";

          const label = document.createElement("label");
          label.textContent = field.label || field.name;
          group.appendChild(label);

          let input;
          if (field.type === "textarea") {
            input = document.createElement("textarea");
          } else if (field.type === "select" && field.options) {
            input = document.createElement("select");
            for (const opt of field.options) {
              const option = document.createElement("option");
              option.value = opt;
              option.textContent = opt;
              input.appendChild(option);
            }
          } else {
            input = document.createElement("input");
            input.type = field.type || "text";
          }
          input.name = field.name;
          input.placeholder = field.placeholder || "";
          group.appendChild(input);
          form.appendChild(group);
        }

        const btn = document.createElement("button");
        btn.type = "submit";
        btn.className = "form-submit";
        btn.textContent = submitLabel;
        form.appendChild(btn);

        container.appendChild(form);
      }

      // â”€â”€ Raw HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function renderHtml(container, content) {
        const html =
          typeof content === "string" ? content : JSON.stringify(content);
        container.innerHTML = `<div class="html-body">${html}</div>`;
      }

      // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateCount() {
        document.getElementById("clientCount").textContent =
          `${widgets.length} widget${widgets.length !== 1 ? "s" : ""}`;
      }

      async function clearCanvas() {
        try {
          await fetch("/api/clear", { method: "POST" });
        } catch {
          // Clear locally if API fails
          widgets.length = 0;
          renderAll();
        }
      }

      // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      connect();
    </script>
  </body>
</html>
